<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Change Password - SubTracker</title>
  <link rel="stylesheet" href="css/design-system.css">
  <style>
    .page-container {
      max-width: 480px;
    }
    
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: var(--sp-2);
      color: var(--text-secondary);
      font-size: var(--text-sm);
      margin-bottom: var(--sp-4);
      text-decoration: none;
    }
    
    .back-link:hover {
      color: var(--text-primary);
    }
    
    .password-requirements {
      margin-top: var(--sp-3);
      padding: var(--sp-3);
      background: var(--bg-surface);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
    }
    
    .password-requirements ul {
      margin: var(--sp-2) 0 0;
      padding-left: var(--sp-5);
      color: var(--text-muted);
    }
    
    .password-requirements li {
      margin-bottom: var(--sp-1);
    }
    
    .password-requirements li.valid {
      color: var(--color-success);
    }
    
    .password-input-wrapper {
      position: relative;
    }
    
    .password-toggle {
      position: absolute;
      right: var(--sp-3);
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: var(--sp-1);
    }
    
    .password-toggle:hover {
      color: var(--text-primary);
    }
    
    .form-actions {
      display: flex;
      gap: var(--sp-3);
      margin-top: var(--sp-5);
    }
    
    @media (max-width: 640px) {
      .form-actions {
        flex-direction: column;
      }
      
      .form-actions .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="app-layout">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2L2 7l10 5 10-5-10-5z"/>
            <path d="M2 17l10 5 10-5"/>
            <path d="M2 12l10 5 10-5"/>
          </svg>
          SubTracker
        </div>
      </div>
      
      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Menu</div>
          <a href="dashboard.html" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="7" height="9" rx="1"/>
              <rect x="14" y="3" width="7" height="5" rx="1"/>
              <rect x="14" y="12" width="7" height="9" rx="1"/>
              <rect x="3" y="16" width="7" height="5" rx="1"/>
            </svg>
            Dashboard
          </a>
          <a href="subscriptions.html" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
            </svg>
            Subscriptions
          </a>
        </div>
        
        <div class="nav-section">
          <div class="nav-section-title">Account</div>
          <a href="settings.html" class="nav-item active">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"/>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
            </svg>
            Settings
          </a>
        </div>
      </nav>
      
      <div class="sidebar-footer">
        <button class="btn btn-ghost" style="width: 100%; justify-content: flex-start;" onclick="handleSignOut()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
            <polyline points="16 17 21 12 16 7"/>
            <line x1="21" y1="12" x2="9" y2="12"/>
          </svg>
          Sign Out
        </button>
      </div>
    </aside>
    
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <main class="main-content">
      <header class="mobile-header">
        <a href="settings.html" class="btn btn-icon btn-ghost">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"/>
          </svg>
        </a>
        <span class="mobile-header-title">Change Password</span>
        <div style="width: 40px;"></div>
      </header>
      
      <div class="page-container">
        <a href="settings.html" class="back-link">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"/>
          </svg>
          Back to Settings
        </a>
        
        <div class="page-header">
          <h1 class="page-title">Change Password</h1>
          <p class="page-subtitle">Update your account password</p>
        </div>
        
        <div id="alertContainer"></div>
        
        <div class="card">
          <form id="passwordForm">
            <div class="form-group">
              <label class="label">Current Password</label>
              <div class="password-input-wrapper">
                <input type="password" class="input" id="currentPassword" placeholder="Enter your current password" required style="padding-right: 44px;">
                <button type="button" class="password-toggle" data-target="currentPassword">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                    <circle cx="12" cy="12" r="3"/>
                  </svg>
                </button>
              </div>
            </div>
            
            <div class="form-group">
              <label class="label">New Password</label>
              <div class="password-input-wrapper">
                <input type="password" class="input" id="newPassword" placeholder="Enter new password" required minlength="8" style="padding-right: 44px;">
                <button type="button" class="password-toggle" data-target="newPassword">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                    <circle cx="12" cy="12" r="3"/>
                  </svg>
                </button>
              </div>
              
              <div class="password-requirements">
                <strong>Password must have:</strong>
                <ul>
                  <li id="req-length">At least 8 characters</li>
                  <li id="req-upper">At least one uppercase letter</li>
                  <li id="req-lower">At least one lowercase letter</li>
                  <li id="req-number">At least one number</li>
                </ul>
              </div>
            </div>
            
            <div class="form-group">
              <label class="label">Confirm New Password</label>
              <div class="password-input-wrapper">
                <input type="password" class="input" id="confirmPassword" placeholder="Confirm new password" required style="padding-right: 44px;">
                <button type="button" class="password-toggle" data-target="confirmPassword">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                    <circle cx="12" cy="12" r="3"/>
                  </svg>
                </button>
              </div>
            </div>
            
            <div class="form-actions">
              <a href="settings.html" class="btn btn-ghost">Cancel</a>
              <button type="submit" class="btn btn-primary" id="submitBtn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                  <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                </svg>
                Update Password
              </button>
            </div>
          </form>
        </div>
      </div>
      
      <nav class="mobile-nav">
        <a href="dashboard.html" class="mobile-nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="7" height="9" rx="1"/>
            <rect x="14" y="3" width="7" height="5" rx="1"/>
            <rect x="14" y="12" width="7" height="9" rx="1"/>
            <rect x="3" y="16" width="7" height="5" rx="1"/>
          </svg>
          <span>Home</span>
        </a>
        <a href="subscriptions.html" class="mobile-nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
          </svg>
          <span>Subs</span>
        </a>
        <a href="subscription-new.html" class="mobile-nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="8" x2="12" y2="16"/>
            <line x1="8" y1="12" x2="16" y2="12"/>
          </svg>
          <span>Add</span>
        </a>
        <a href="settings.html" class="mobile-nav-item active">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"/>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
          </svg>
          <span>Settings</span>
        </a>
      </nav>
    </main>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <script src="js/components.js"></script>
  <script src="js/supabase-client.js"></script>
  
  <script>
    let client;
    
    async function init() {
      client = initSupabase();
      
      try {
        await requireAuth(client);
      } catch (err) {
        console.error('Auth error:', err);
        window.location.href = 'login.html';
      }
    }
    
    // Password toggle buttons
    document.querySelectorAll('.password-toggle').forEach(btn => {
      btn.addEventListener('click', function() {
        const targetId = this.getAttribute('data-target');
        const input = document.getElementById(targetId);
        const isPassword = input.type === 'password';
        input.type = isPassword ? 'text' : 'password';
        
        this.innerHTML = isPassword 
          ? '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>'
          : '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>';
      });
    });
    
    // Password strength validation
    document.getElementById('newPassword').addEventListener('input', function() {
      const password = this.value;
      
      document.getElementById('req-length').classList.toggle('valid', password.length >= 8);
      document.getElementById('req-upper').classList.toggle('valid', /[A-Z]/.test(password));
      document.getElementById('req-lower').classList.toggle('valid', /[a-z]/.test(password));
      document.getElementById('req-number').classList.toggle('valid', /[0-9]/.test(password));
    });
    
    // Form submission
    document.getElementById('passwordForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const submitBtn = document.getElementById('submitBtn');
      const alertContainer = document.getElementById('alertContainer');
      
      alertContainer.innerHTML = '';
      
      // Validate passwords match
      if (newPassword !== confirmPassword) {
        alertContainer.innerHTML = '<div class="alert alert-error">New passwords do not match</div>';
        return;
      }
      
      // Validate password strength
      if (newPassword.length < 8 || !/[A-Z]/.test(newPassword) || !/[a-z]/.test(newPassword) || !/[0-9]/.test(newPassword)) {
        alertContainer.innerHTML = '<div class="alert alert-error">Password does not meet requirements</div>';
        return;
      }
      
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner" style="width:16px;height:16px;border-width:2px;"></span> Updating...';
      
      try {
        // Get current session for auth header
        const { data: { session } } = await client.auth.getSession();
        
        // Call the secure edge function
        const response = await fetch(`${CONFIG.supabaseUrl}/functions/v1/secure-actions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session.access_token}`
          },
          body: JSON.stringify({
            action: 'change_password',
            currentPassword: currentPassword,
            newPassword: newPassword
          })
        });
        
        const result = await response.json();
        
        if (!response.ok) {
          throw new Error(result.error || 'Failed to change password');
        }
        
        // Success
        alertContainer.innerHTML = '<div class="alert alert-success">Password updated successfully! Redirecting...</div>';
        
        // Sign out and redirect to login
        setTimeout(async () => {
          await client.auth.signOut();
          window.location.href = 'login.html';
        }, 2000);
        
      } catch (err) {
        alertContainer.innerHTML = `<div class="alert alert-error">${err.message}</div>`;
        submitBtn.disabled = false;
        submitBtn.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
          </svg>
          Update Password
        `;
      }
    });
    
    async function handleSignOut() {
      await signOut(client);
      window.location.href = 'login.html';
    }
    
    init();
  </script>
</body>
</html>
