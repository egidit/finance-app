<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Personal Finance</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="js/supabase-lib.js"></script>
  <script src="js/password-strength.js"></script>
</head>
<body class="app-body">

  <!-- Mobile Header -->
  <header class="app-header">
    <button id="mobileMenuBtn" class="icon-btn" aria-label="Menu">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
      </svg>
    </button>
    <h1 class="app-title">Personal Finance</h1>
    <div class="header-spacer"></div>
  </header>

  <!-- Mobile Menu Overlay -->
  <div id="mobileMenu" class="mobile-menu-overlay">
    <div class="mobile-menu">
      <div class="mobile-menu-header">
        <div class="menu-user-info">
          <div class="avatar-large" id="menuAvatar">U</div>
          <div class="menu-user-details">
            <div class="menu-user-name" id="menuUserName">Loading...</div>
            <div class="menu-user-email" id="menuUserEmail"></div>
          </div>
        </div>
        <button id="closeMobileMenu" class="icon-btn">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <nav class="mobile-menu-nav">
        <button class="menu-item" data-action="logout">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
          </svg>
          <span>Logout</span>
        </button>
      </nav>
    </div>
  </div>

  <!-- Desktop Sidebar -->
  <aside class="desktop-sidebar">
    <div class="sidebar-header">
      <h1 class="sidebar-title">Personal Finance</h1>
    </div>
    
    <nav class="sidebar-nav">
      <button class="sidebar-nav-btn active" data-tab="dashboard">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
        </svg>
        <span>Dashboard</span>
      </button>
      <button class="sidebar-nav-btn" data-tab="income">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <span>Income</span>
      </button>
      <button class="sidebar-nav-btn" data-tab="expenses">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
        </svg>
        <span>Expenses</span>
      </button>
    </nav>

    <div class="sidebar-footer">
      <button class="sidebar-user" id="sidebarUserBtn">
        <div class="avatar-large" id="sidebarAvatar">U</div>
        <div class="sidebar-user-info">
          <div class="sidebar-user-name" id="sidebarUserName">Loading...</div>
          <div class="sidebar-user-email" id="sidebarUserEmail"></div>
        </div>
      </button>
      <button class="btn-full btn-secondary" onclick="handleLogout()">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px; margin-right: 8px;">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
        </svg>
        Logout
      </button>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="app-main">
    
    <!-- Dashboard Tab -->
    <section id="dashboardTab" class="tab-view active">
      <div class="page-header">
        <h2>Dashboard</h2>
        <p class="page-subtitle">Your financial overview</p>
      </div>

      <!-- Stats Cards -->
      <div class="stats-row">
        <div class="stat-card stat-income">
          <div class="stat-icon-wrapper">
            <svg class="stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <div class="stat-label">Total Income</div>
          <div class="stat-value" id="totalIncome">$0.00</div>
        </div>

        <div class="stat-card stat-expense">
          <div class="stat-icon-wrapper">
            <svg class="stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
            </svg>
          </div>
          <div class="stat-label">Total Expenses</div>
          <div class="stat-value" id="totalExpenses">$0.00</div>
        </div>

        <div class="stat-card stat-balance">
          <div class="stat-icon-wrapper">
            <svg class="stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
          </div>
          <div class="stat-label">Balance</div>
          <div class="stat-value" id="balance">$0.00</div>
        </div>
      </div>

      <!-- Chart Card -->
      <div class="card">
        <div class="card-header-simple">
          <h3 class="card-title">Overview</h3>
        </div>
        <div class="chart-container">
          <canvas id="financeChart"></canvas>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="card">
        <div class="card-header-simple">
          <h3 class="card-title">Recent Activity</h3>
        </div>
        <div id="recentActivity" class="activity-list"></div>
        <div id="recentEmpty" class="empty-view-sm" style="display: none;">
          <p>No recent transactions</p>
        </div>
      </div>
    </section>

    <!-- Income Tab -->
    <section id="incomeTab" class="tab-view">
      <div class="page-header">
        <div class="page-header-content">
          <div>
            <h2>Income</h2>
            <p class="page-subtitle">Track your income sources</p>
          </div>
          <button id="addIncomeBtnDesktop" class="btn-primary btn-desktop-add">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Add Income
          </button>
        </div>
      </div>

      <div class="card">
        <div id="incomeList" class="list-view"></div>
        <div id="incomeEmpty" class="empty-view" style="display: none;">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <h3>No Income Yet</h3>
          <p>Tap the + button to add income</p>
        </div>
      </div>

      <button id="addIncomeBtn" class="btn-fab">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
      </button>
    </section>

    <!-- Expenses Tab -->
    <section id="expensesTab" class="tab-view">
      <div class="page-header">
        <div class="page-header-content">
          <div>
            <h2>Expenses</h2>
            <p class="page-subtitle">Manage your expenses</p>
          </div>
          <button id="addExpenseBtnDesktop" class="btn-primary btn-desktop-add">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Add Expense
          </button>
        </div>
      </div>

      <div class="card">
        <div id="expensesList" class="list-view"></div>
        <div id="expensesEmpty" class="empty-view" style="display: none;">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
          </svg>
          <h3>No Expenses Yet</h3>
          <p>Tap the + button to add expense</p>
        </div>
      </div>

      <button id="addExpenseBtn" class="btn-fab">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
      </button>
    </section>

    <!-- Profile Tab -->
    <section id="profileTab" class="tab-view">
      <div class="page-header">
        <h2>Profile</h2>
        <p class="page-subtitle">Manage your account</p>
      </div>

      <!-- Account Info Card -->
      <div class="card">
        <div class="card-header-simple">
          <h3 class="card-title">Account Information</h3>
        </div>
        <form id="updateUsernameForm" class="form-standard">
          <div class="form-group">
            <label class="form-label">Username</label>
            <input type="text" id="usernameInput" class="form-input" placeholder="Enter your username" required>
          </div>
          <div class="form-group">
            <label class="form-label">Email</label>
            <div class="form-display" id="emailDisplay"></div>
          </div>
          <button type="submit" class="btn-full btn-primary">Update</button>
        </form>
      </div>

      <!-- Security Card -->
      <div class="card">
        <div class="card-header-simple">
          <h3 class="card-title">Security</h3>
        </div>
        <div class="settings-list">
          <button class="settings-item" id="changePasswordBtn">
            <div class="settings-icon">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
              </svg>
            </div>
            <div class="settings-content">
              <div class="settings-label">Change Password</div>
              <div class="settings-desc">Update your password</div>
            </div>
            <svg class="settings-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </button>

          <div class="settings-item">
            <div class="settings-icon">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
              </svg>
            </div>
            <div class="settings-content">
              <div class="settings-label">Two-Factor Auth</div>
              <div class="settings-desc">
                <span class="status-badge" id="mfaStatusBadge"></span>
                <span id="mfaStatusText">Loading...</span>
              </div>
            </div>
            <div class="settings-actions">
              <button id="enableMFABtn" class="btn-sm btn-primary" style="display: none;">Enable</button>
              <button id="disableMFABtn" class="btn-sm btn-danger" style="display: none;">Disable</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Danger Zone -->
      <div class="card card-danger">
        <div class="card-header-simple">
          <h3 class="card-title">Danger Zone</h3>
        </div>
        <p class="card-text">Permanently delete your account and all data. This action cannot be undone.</p>
        <button id="deleteAccountBtn" class="btn-full btn-danger-outline">Delete Account</button>
      </div>
    </section>

  </main>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <button class="nav-btn active" data-tab="dashboard">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
      </svg>
      <span>Dashboard</span>
    </button>
    <button class="nav-btn" data-tab="income">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <span>Income</span>
    </button>
    <button class="nav-btn" data-tab="expenses">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
      </svg>
      <span>Expenses</span>
    </button>
  </nav>

  <!-- Income Modal -->
  <div id="incomeModal" class="modal-overlay">
    <div class="modal mobile-modal">
      <div class="modal-header">
        <h3 id="incomeModalTitle">Add Income</h3>
        <button class="icon-btn" onclick="closeIncomeModal()">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <form id="incomeForm" class="modal-form">
        <input type="hidden" id="incomeId">
        <div class="form-group">
          <label class="form-label">Source</label>
          <input type="text" id="incomeSource" class="form-input" placeholder="e.g., Salary" required>
        </div>
        <div class="form-group">
          <label class="form-label">Amount</label>
          <input type="number" id="incomeAmount" class="form-input" placeholder="0.00" step="0.01" required>
        </div>
        <div class="form-group">
          <label class="form-label">Frequency</label>
          <select id="incomeFrequency" class="form-input" required>
            <option value="monthly">Monthly</option>
            <option value="weekly">Weekly</option>
            <option value="yearly">Yearly</option>
            <option value="one-time">One-time</option>
          </select>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-half btn-secondary" onclick="closeIncomeModal()">Cancel</button>
          <button type="submit" class="btn-half btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Expense Modal -->
  <div id="expenseModal" class="modal-overlay">
    <div class="modal mobile-modal">
      <div class="modal-header">
        <h3 id="expenseModalTitle">Add Expense</h3>
        <button class="icon-btn" onclick="closeExpenseModal()">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <form id="expenseForm" class="modal-form">
        <input type="hidden" id="expenseId">
        <div class="form-group">
          <label class="form-label">Name</label>
          <input type="text" id="expenseName" class="form-input" placeholder="e.g., Grocery Shopping" required>
        </div>
        <div class="form-group">
          <label class="form-label">Category</label>
          <input type="text" id="expenseCategory" class="form-input" placeholder="e.g., Food" required>
        </div>
        <div class="form-group">
          <label class="form-label">Amount</label>
          <input type="number" id="expenseAmount" class="form-input" placeholder="0.00" step="0.01" required>
        </div>
        <div class="form-group">
          <label class="form-label">Due Date</label>
          <input type="date" id="expenseDueDate" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="expenseRecurring" style="width: 20px; height: 20px; cursor: pointer;">
            <span>Recurring expense</span>
          </label>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-half btn-secondary" onclick="closeExpenseModal()">Cancel</button>
          <button type="submit" class="btn-half btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Password Modal -->
  <div id="passwordModal" class="modal-overlay">
    <div class="modal mobile-modal">
      <div class="modal-header">
        <h3>Change Password</h3>
        <button class="icon-btn" onclick="closePasswordModal()">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <form id="passwordForm" class="modal-form">
        <div class="form-group">
          <label class="form-label">Current Password</label>
          <input type="password" id="currentPassword" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label">New Password</label>
          <input type="password" id="newPassword" class="form-input" required>
          <div class="password-requirements">
            <div class="password-requirements-title">Password must contain:</div>
            <div class="password-requirement" data-requirement="length">
              <span class="requirement-icon circle">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <circle cx="12" cy="12" r="10" stroke-width="2"></circle>
                </svg>
              </span>
              <span>At least 8 characters</span>
            </div>
            <div class="password-requirement" data-requirement="lowercase">
              <span class="requirement-icon circle">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <circle cx="12" cy="12" r="10" stroke-width="2"></circle>
                </svg>
              </span>
              <span>Lowercase letter (a-z)</span>
            </div>
            <div class="password-requirement" data-requirement="uppercase">
              <span class="requirement-icon circle">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <circle cx="12" cy="12" r="10" stroke-width="2"></circle>
                </svg>
              </span>
              <span>Uppercase letter (A-Z)</span>
            </div>
            <div class="password-requirement" data-requirement="digit">
              <span class="requirement-icon circle">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <circle cx="12" cy="12" r="10" stroke-width="2"></circle>
                </svg>
              </span>
              <span>Number (0-9)</span>
            </div>
            <div class="password-requirement" data-requirement="symbol">
              <span class="requirement-icon circle">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <circle cx="12" cy="12" r="10" stroke-width="2"></circle>
                </svg>
              </span>
              <span>Special character (!@#$%^&*)</span>
            </div>
          </div>
          <div class="password-strength-bar">
            <div class="password-strength-bar-fill" style="width: 0%"></div>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Confirm New Password</label>
          <input type="password" id="confirmPassword" class="form-input" required>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-half btn-secondary" onclick="closePasswordModal()">Cancel</button>
          <button type="submit" class="btn-half btn-primary">Update</button>
        </div>
      </form>
    </div>
  </div>

  <!-- MFA Enable Modal -->
  <div id="enableMFAModal" class="modal-overlay">
    <div class="modal mobile-modal">
      <div class="modal-header">
        <h3>Enable 2FA</h3>
        <button class="icon-btn" onclick="closeEnableMFAModal()">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <!-- Step 1: QR Code -->
        <div id="mfaStep1" class="mfa-step">
          <p class="step-text">Scan with your authenticator app</p>
          <div id="qrCodeContainer" class="qr-container"></div>
          <div class="secret-key-section">
            <p class="secret-key-label">Or enter this key manually:</p>
            <div class="secret-key-display">
              <code id="secretKeyText" class="secret-key-code"></code>
              <button type="button" class="btn-icon" onclick="copySecretKey()" title="Copy to clipboard">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                </svg>
              </button>
            </div>
            <p class="form-hint">Use this if you can't scan the QR code (e.g., on mobile)</p>
          </div>
          <button type="button" class="btn-full btn-primary" onclick="showMFAStep2()">Next</button>
        </div>
        <!-- Step 2: Verify Code -->
        <div id="mfaStep2" class="mfa-step" style="display: none;">
          <p class="step-text">Enter the 6-digit code</p>
          <form id="verifyMFAForm" class="modal-form">
            <div class="form-group">
              <input type="text" id="mfaVerifyCode" class="form-input code-input" placeholder="000000" maxlength="6" inputmode="numeric" pattern="[0-9]{6}" required>
            </div>
            <div class="modal-actions">
              <button type="button" class="btn-half btn-secondary" onclick="showMFAStep1()">Back</button>
              <button type="submit" class="btn-half btn-primary">Verify</button>
            </div>
          </form>
        </div>
        <!-- Step 3: Recovery Codes -->
        <div id="mfaStep3" class="mfa-step" style="display: none;">
          <div class="alert alert-warning" style="margin-bottom: var(--space-4);">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 24px; height: 24px; flex-shrink: 0;">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
            <div>
              <strong style="display: block; margin-bottom: 4px;">IMPORTANT: Save these recovery codes now!</strong>
              <span>If you lose access to your authenticator app, these codes are the ONLY way to access your account. Store them in a password manager or write them down and keep them in a secure location.</span>
            </div>
          </div>
          <div class="recovery-codes-section">
            <div class="recovery-codes-header">
              <span class="recovery-codes-label">Your Recovery Codes</span>
              <button type="button" class="btn-icon" onclick="copyRecoveryCodes()" title="Copy all codes">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                </svg>
              </button>
            </div>
            <div id="recoveryCodesDisplay" class="recovery-codes"></div>
          </div>
          <button type="button" class="btn-full btn-primary" onclick="closeEnableMFAModal()">I've Saved My Codes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MFA Disable Modal -->
  <div id="disableMFAModal" class="modal-overlay">
    <div class="modal mobile-modal">
      <div class="modal-header">
        <h3>Disable 2FA</h3>
        <button class="icon-btn" onclick="closeDisableMFAModal()">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning">
          <strong>Security Verification Required</strong>
          <p>To disable 2FA, you must verify your identity with your password and MFA code.</p>
        </div>
        <form onsubmit="handleDisableMFA(event)">
          <div class="form-group">
            <label for="disableMfaPassword">Current Password</label>
            <input type="password" id="disableMfaPassword" required autocomplete="current-password">
          </div>
          <div class="form-group">
            <label for="disableMfaCode">MFA Code (from your authenticator app)</label>
            <input type="text" id="disableMfaCode" required pattern="[0-9]{6}" maxlength="6" placeholder="000000" autocomplete="one-time-code">
          </div>
          <div class="modal-actions">
            <button type="button" class="btn-half btn-secondary" onclick="closeDisableMFAModal()">Cancel</button>
            <button type="submit" class="btn-half btn-danger">Disable 2FA</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Delete Account Confirmation Modal -->
  <div id="deleteAccountModal" class="modal-overlay">
    <div class="modal mobile-modal">
      <div class="modal-header">
        <h3>Delete Account</h3>
        <button class="icon-btn" onclick="closeDeleteAccountModal()">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <p class="warning-text">To delete your account, please contact support at <a href="mailto:support@egidit.com">support@egidit.com</a></p>
        <div class="modal-actions">
          <button type="button" class="btn-full btn-secondary" onclick="closeDeleteAccountModal()">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteConfirmModal" class="modal-overlay">
    <div class="modal mobile-modal">
      <div class="modal-header">
        <h3 id="deleteConfirmTitle">Delete Item</h3>
        <button class="icon-btn" onclick="closeDeleteConfirmModal()">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <p id="deleteConfirmMessage">Are you sure you want to delete this item?</p>
        <div class="modal-actions">
          <button type="button" class="btn-half btn-secondary" onclick="closeDeleteConfirmModal()">Cancel</button>
          <button type="button" class="btn-half btn-danger" onclick="confirmDelete()">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <!-- Scripts -->
  <script src="js/supabase.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/guard.js"></script>
  <script src="js/app.js"></script>
</body>
</html>
