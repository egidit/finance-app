<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Reset Password - Subscription Tracker</title>
  
  <link rel="stylesheet" href="css/tokens.css">
  <link rel="stylesheet" href="css/components.css">
  <link rel="stylesheet" href="css/layout.css">
  
  <style>
    .auth-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--spacing-4);
    }
    
    .auth-card {
      max-width: 400px;
      width: 100%;
    }
    
    .auth-header {
      text-align: center;
      margin-bottom: var(--spacing-6);
    }
    
    .auth-title {
      font-size: var(--font-size-2xl);
      font-weight: 700;
      margin-bottom: var(--spacing-2);
    }
    
    .auth-form {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-4);
    }
    
    .password-strength {
      height: 4px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-full);
      margin-top: var(--spacing-2);
      overflow: hidden;
    }
    
    .password-strength-bar {
      height: 100%;
      transition: width 0.3s, background 0.3s;
      border-radius: var(--radius-full);
    }
    
    .password-strength-text {
      font-size: var(--font-size-xs);
      margin-top: var(--spacing-1);
      color: var(--text-secondary);
    }
  </style>
</head>
<body>
  <div class="auth-container">
    <div class="card card-heavy auth-card">
      <div class="card-content">
        <div class="auth-header">
          <h1 class="auth-title">Set New Password</h1>
          <p>Enter your new password below</p>
        </div>
        
        <div id="alertContainer"></div>
        
        <!-- Loading State -->
        <div id="loadingState" class="text-center" style="padding: var(--spacing-8);">
          <p>Verifying your reset link...</p>
        </div>
        
        <!-- Error State (invalid/expired link) -->
        <div id="errorState" class="hidden text-center">
          <div style="font-size: 48px; margin-bottom: var(--spacing-4);">❌</div>
          <h3 style="margin-bottom: var(--spacing-2);">Invalid Reset Link</h3>
          <p style="color: var(--text-secondary); margin-bottom: var(--spacing-4);">
            This password reset link is invalid or has expired.
          </p>
          <a href="forgot-password.html" class="btn btn-primary">Request New Link</a>
        </div>
        
        <!-- Reset Form -->
        <form id="resetForm" class="auth-form hidden">
          <div class="input-group">
            <label for="password" class="input-label">New Password</label>
            <input 
              type="password" 
              id="password" 
              class="input" 
              placeholder="••••••••"
              required
              minlength="8"
            >
            <div class="password-strength">
              <div id="strengthBar" class="password-strength-bar" style="width: 0%;"></div>
            </div>
            <div id="strengthText" class="password-strength-text"></div>
          </div>
          
          <div class="input-group">
            <label for="confirmPassword" class="input-label">Confirm New Password</label>
            <input 
              type="password" 
              id="confirmPassword" 
              class="input" 
              placeholder="••••••••"
              required
            >
          </div>
          
          <button type="submit" class="btn btn-primary" id="submitBtn">
            Update Password
          </button>
        </form>
        
        <!-- Success State -->
        <div id="successState" class="hidden text-center">
          <div style="font-size: 48px; margin-bottom: var(--spacing-4);">✅</div>
          <h3 style="margin-bottom: var(--spacing-2);">Password Updated!</h3>
          <p style="color: var(--text-secondary); margin-bottom: var(--spacing-4);">
            Your password has been successfully changed.
          </p>
          <a href="login.html" class="btn btn-primary">Sign In</a>
        </div>
      </div>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/supabase-client.js"></script>
  
  <script>
    const client = initSupabase();
    
    // Check for valid session from password reset link
    async function checkSession() {
      const { data: { session }, error } = await client.auth.getSession();
      
      if (error || !session) {
        // Try to extract access token from URL hash
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        const accessToken = hashParams.get('access_token');
        const type = hashParams.get('type');
        
        if (type === 'recovery' && accessToken) {
          // Set the session from the recovery token
          const { error: setError } = await client.auth.setSession({
            access_token: accessToken,
            refresh_token: hashParams.get('refresh_token')
          });
          
          if (setError) {
            showErrorState();
            return;
          }
          
          showResetForm();
        } else {
          showErrorState();
        }
      } else {
        showResetForm();
      }
    }
    
    function showErrorState() {
      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('errorState').classList.remove('hidden');
    }
    
    function showResetForm() {
      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('resetForm').classList.remove('hidden');
    }
    
    // Password strength checker
    function checkPasswordStrength(password) {
      let strength = 0;
      
      if (password.length >= 8) strength++;
      if (password.length >= 12) strength++;
      if (/[A-Z]/.test(password)) strength++;
      if (/[a-z]/.test(password)) strength++;
      if (/[0-9]/.test(password)) strength++;
      if (/[^A-Za-z0-9]/.test(password)) strength++;
      
      if (strength <= 2) return { level: 'weak', percent: 25, color: 'var(--color-error)' };
      if (strength <= 3) return { level: 'fair', percent: 50, color: 'var(--color-warning)' };
      if (strength <= 4) return { level: 'good', percent: 75, color: 'var(--color-info)' };
      return { level: 'strong', percent: 100, color: 'var(--color-success)' };
    }
    
    document.getElementById('password').addEventListener('input', (e) => {
      const password = e.target.value;
      const strength = checkPasswordStrength(password);
      
      document.getElementById('strengthBar').style.width = strength.percent + '%';
      document.getElementById('strengthBar').style.background = strength.color;
      document.getElementById('strengthText').textContent = password ? `Password strength: ${strength.level}` : '';
    });
    
    document.getElementById('resetForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const submitBtn = document.getElementById('submitBtn');
      
      document.getElementById('alertContainer').innerHTML = '';
      
      // Validate password
      const validation = validatePassword(password);
      if (!validation.valid) {
        document.getElementById('alertContainer').innerHTML = 
          `<div class="alert alert-error">${validation.errors.join('<br>')}</div>`;
        return;
      }
      
      if (password !== confirmPassword) {
        document.getElementById('alertContainer').innerHTML = 
          '<div class="alert alert-error">Passwords do not match</div>';
        return;
      }
      
      setLoading(submitBtn, true);
      
      try {
        const { error } = await client.auth.updateUser({ password });
        
        if (error) throw error;
        
        // Show success state
        document.getElementById('resetForm').classList.add('hidden');
        document.getElementById('successState').classList.remove('hidden');
        
      } catch (err) {
        document.getElementById('alertContainer').innerHTML = 
          `<div class="alert alert-error">${err.message}</div>`;
        setLoading(submitBtn, false);
      }
    });
    
    // Initialize
    checkSession();
  </script>
</body>
</html>
